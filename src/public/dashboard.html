<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Productos App - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: #0f172a;
      min-height: 100vh;
      color: white;
    }

    nav {
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid rgba(255,255,255,0.06);
      padding: 0 30px;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .nav-brand .icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .nav-user {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 34px; height: 34px;
      background: linear-gradient(135deg, #6366f1, #ec4899);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
    }

    .nav-user span {
      color: rgba(255,255,255,0.7);
      font-size: 0.88rem;
    }

    .btn-logout {
      background: rgba(239,68,68,0.12);
      color: #f87171;
      border: 1px solid rgba(239,68,68,0.2);
      padding: 8px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.82rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }

    .btn-logout:hover { background: rgba(239,68,68,0.2); }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 24px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 20px;
    }

    .stat-card .label {
      color: rgba(255,255,255,0.4);
      font-size: 0.82rem;
      font-weight: 500;
      margin-bottom: 6px;
    }

    .stat-card .value {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .stat-card .value.purple { color: #a78bfa; }
    .stat-card .value.green { color: #4ade80; }
    .stat-card .value.pink { color: #f472b6; }

    .header-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .header-section h2 {
      font-size: 1.3rem;
      font-weight: 700;
    }

    .btn-nuevo {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-nuevo:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 25px rgba(99,102,241,0.35);
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active { display: flex; }

    .modal {
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 32px;
      width: 100%;
      max-width: 480px;
      margin: 20px;
    }

    .modal h3 {
      margin-bottom: 24px;
      font-size: 1.2rem;
    }

    .modal .form-group { margin-bottom: 16px; }

    .modal label {
      display: block;
      margin-bottom: 6px;
      color: rgba(255,255,255,0.5);
      font-weight: 500;
      font-size: 0.85rem;
    }

    .modal input, .modal textarea {
      width: 100%;
      padding: 12px 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      font-size: 0.92rem;
      color: white;
      outline: none;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }

    .modal input::placeholder, .modal textarea::placeholder {
      color: rgba(255,255,255,0.2);
    }

    .modal input:focus, .modal textarea:focus, .modal select:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 3px rgba(99,102,241,0.12);
    }

    .modal select {
      width: 100%;
      padding: 12px 14px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 10px;
      font-size: 0.92rem;
      color: white;
      outline: none;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23a78bfa' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
    }

    .modal select option {
      background: #1e293b;
      color: white;
    }

    .modal textarea { resize: vertical; min-height: 70px; }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 24px;
    }

    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 0.92rem;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }

    .btn-guardar {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white;
      border: none;
    }

    .btn-guardar:hover { box-shadow: 0 4px 15px rgba(99,102,241,0.3); }

    .btn-cancelar {
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .btn-cancelar:hover { background: rgba(255,255,255,0.1); }

    .productos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    .producto-card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      padding: 22px;
      transition: all 0.3s;
    }

    .producto-card:hover {
      border-color: rgba(99,102,241,0.3);
      background: rgba(255,255,255,0.06);
    }

    .producto-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .producto-card h4 {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .producto-categoria {
      background: rgba(99,102,241,0.15);
      color: #a78bfa;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }

    .producto-descripcion {
      color: rgba(255,255,255,0.4);
      font-size: 0.85rem;
      margin-bottom: 16px;
      min-height: 20px;
      line-height: 1.4;
    }

    .producto-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      padding: 12px 0;
      border-top: 1px solid rgba(255,255,255,0.06);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .producto-precio {
      font-weight: 700;
      font-size: 1.3rem;
      background: linear-gradient(135deg, #6366f1, #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .producto-stock {
      color: rgba(255,255,255,0.4);
      font-size: 0.85rem;
    }

    .producto-stock span {
      color: #4ade80;
      font-weight: 600;
    }

    .producto-acciones {
      display: flex;
      gap: 8px;
    }

    .producto-acciones button {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      font-size: 0.85rem;
      cursor: pointer;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
      border: none;
    }

    .btn-editar {
      background: rgba(99,102,241,0.12);
      color: #a78bfa;
    }

    .btn-editar:hover { background: rgba(99,102,241,0.2); }

    .btn-eliminar {
      background: rgba(239,68,68,0.1);
      color: #f87171;
    }

    .btn-eliminar:hover { background: rgba(239,68,68,0.2); }

    .sin-productos {
      text-align: center;
      padding: 80px 20px;
      grid-column: 1 / -1;
    }

    .sin-productos .empty-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.6;
    }

    .sin-productos p {
      color: rgba(255,255,255,0.5);
      font-size: 1.05rem;
      margin-bottom: 6px;
    }

    .sin-productos small {
      color: rgba(255,255,255,0.3);
      font-size: 0.88rem;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 24px;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      z-index: 200;
      display: none;
      animation: slideIn 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .toast.exito {
      display: block;
      background: rgba(34,197,94,0.9);
      backdrop-filter: blur(8px);
    }

    .toast.error {
      display: block;
      background: rgba(239,68,68,0.9);
      backdrop-filter: blur(8px);
    }

    @keyframes slideIn {
      from { transform: translateX(100px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .confirm-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 150;
      align-items: center;
      justify-content: center;
    }

    .confirm-overlay.active { display: flex; }

    .confirm-box {
      background: #1e293b;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      max-width: 380px;
      width: 100%;
      margin: 20px;
    }

    .confirm-box .icon-warn {
      font-size: 2.5rem;
      margin-bottom: 12px;
    }

    .confirm-box p {
      color: rgba(255,255,255,0.7);
      margin-bottom: 20px;
      font-size: 0.95rem;
      line-height: 1.5;
    }

    .confirm-buttons {
      display: flex;
      gap: 10px;
    }

    .confirm-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }

    .btn-confirm-cancel {
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.6);
      border: 1px solid rgba(255,255,255,0.1);
    }

    .btn-confirm-delete {
      background: rgba(239,68,68,0.8);
      color: white;
      border: none;
    }

    .btn-confirm-delete:hover { background: rgba(239,68,68,0.95); }
  </style>
</head>
<body>
  <nav>
    <div class="nav-brand">
      <div class="icon">游닍</div>
      <span>Productos App</span>
    </div>
    <div class="nav-right">
      <div class="nav-user">
        <div class="avatar" id="avatarLetra"></div>
        <span id="nombreUsuario"></span>
      </div>
      <button class="btn-logout" onclick="cerrarSesion()">Cerrar sesi칩n</button>
    </div>
  </nav>

  <div class="container">
    <div class="stats" id="statsSection">
      <div class="stat-card">
        <div class="label">Total Productos</div>
        <div class="value purple" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Stock Total</div>
        <div class="value green" id="statStock">0</div>
      </div>
      <div class="stat-card">
        <div class="label">Categor칤as</div>
        <div class="value pink" id="statCategorias">0</div>
      </div>
    </div>

    <div class="header-section">
      <h2>Mis Productos</h2>
      <button class="btn-nuevo" onclick="abrirModal()">
        <span>+</span> Nuevo Producto
      </button>
    </div>

    <div class="productos-grid" id="productosGrid"></div>
  </div>

  <div class="modal-overlay" id="modalOverlay" onclick="cerrarModalFuera(event)">
    <div class="modal">
      <h3 id="modalTitulo">Nuevo Producto</h3>
      <form onsubmit="guardarProducto(event)">
        <input type="hidden" id="productoId">
        <div class="form-group">
          <label>Nombre del producto</label>
          <input type="text" id="nombre" required placeholder="Ej: Laptop Gaming">
        </div>
        <div class="form-group">
          <label>Descripci칩n</label>
          <textarea id="descripcion" placeholder="Describe el producto..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Precio ($)</label>
            <input type="number" id="precio" required min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Stock</label>
            <input type="number" id="stock" min="0" value="0" placeholder="0">
          </div>
        </div>
        <div class="form-group">
          <label>Categor칤a</label>
          <select id="categoria">
            <option value="General">General</option>
            <option value="Electr칩nica">Electr칩nica</option>
            <option value="Ropa">Ropa</option>
            <option value="Alimentos">Alimentos</option>
            <option value="Hogar">Hogar</option>
            <option value="Deportes">Deportes</option>
            <option value="Papeler칤a">Papeler칤a</option>
            <option value="Tecnolog칤a">Tecnolog칤a</option>
            <option value="Salud">Salud</option>
            <option value="Juguetes">Juguetes</option>
          </select>
        </div>
        <div class="modal-buttons">
          <button type="button" class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
          <button type="submit" class="btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="confirm-overlay" id="confirmOverlay">
    <div class="confirm-box">
      <div class="icon-warn">丘멆잺</div>
      <p>쮼st치s seguro de que quieres eliminar este producto? Esta acci칩n no se puede deshacer.</p>
      <div class="confirm-buttons">
        <button class="btn-confirm-cancel" onclick="cerrarConfirm()">Cancelar</button>
        <button class="btn-confirm-delete" id="btnConfirmDelete">Eliminar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API = '/api';
    let token = localStorage.getItem('token');
    let usuario = JSON.parse(localStorage.getItem('usuario') || 'null');
    let productoAEliminar = null;

    if (!token || !usuario) {
      window.location.href = '/login.html';
    }

    document.getElementById('nombreUsuario').textContent = usuario ? usuario.nombre : '';
    document.getElementById('avatarLetra').textContent = usuario ? usuario.nombre.charAt(0).toUpperCase() : '?';

    function headers() {
      return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token
      };
    }

    function mostrarToast(texto, tipo) {
      const toast = document.getElementById('toast');
      toast.textContent = texto;
      toast.className = 'toast ' + tipo;
      setTimeout(() => { toast.className = 'toast'; }, 3000);
    }

    function cerrarSesion() {
      localStorage.removeItem('token');
      localStorage.removeItem('usuario');
      window.location.href = '/login.html';
    }

    function abrirModal(producto) {
      document.getElementById('modalTitulo').textContent = producto ? 'Editar Producto' : 'Nuevo Producto';
      document.getElementById('productoId').value = producto ? producto._id : '';
      document.getElementById('nombre').value = producto ? producto.nombre : '';
      document.getElementById('descripcion').value = producto ? producto.descripcion : '';
      document.getElementById('precio').value = producto ? producto.precio : '';
      document.getElementById('categoria').value = producto ? producto.categoria : '';
      document.getElementById('stock').value = producto ? producto.stock : 0;
      document.getElementById('modalOverlay').classList.add('active');
    }

    function cerrarModal() {
      document.getElementById('modalOverlay').classList.remove('active');
    }

    function cerrarModalFuera(e) {
      if (e.target === e.currentTarget) cerrarModal();
    }

    function confirmarEliminar(id) {
      productoAEliminar = id;
      document.getElementById('confirmOverlay').classList.add('active');
    }

    function cerrarConfirm() {
      productoAEliminar = null;
      document.getElementById('confirmOverlay').classList.remove('active');
    }

    document.getElementById('btnConfirmDelete').addEventListener('click', async () => {
      if (!productoAEliminar) return;
      try {
        const res = await fetch(API + '/productos/' + productoAEliminar, {
          method: 'DELETE',
          headers: headers()
        });
        if (res.ok) {
          mostrarToast('Producto eliminado correctamente', 'exito');
          cargarProductos();
        } else {
          mostrarToast('Error al eliminar', 'error');
        }
      } catch (err) {
        mostrarToast('Error de conexi칩n', 'error');
      }
      cerrarConfirm();
    });

    function actualizarStats(productos) {
      document.getElementById('statTotal').textContent = productos.length;
      const stockTotal = productos.reduce((sum, p) => sum + (p.stock || 0), 0);
      document.getElementById('statStock').textContent = stockTotal;
      const categorias = new Set(productos.map(p => p.categoria || 'General'));
      document.getElementById('statCategorias').textContent = categorias.size;
    }

    async function cargarProductos() {
      try {
        const res = await fetch(API + '/productos', { headers: headers() });

        if (res.status === 401 || res.status === 403) {
          cerrarSesion();
          return;
        }

        const productos = await res.json();
        actualizarStats(productos);
        const grid = document.getElementById('productosGrid');

        if (productos.length === 0) {
          grid.innerHTML = `
            <div class="sin-productos">
              <div class="empty-icon">游닔</div>
              <p>No hay productos todav칤a</p>
              <small>Haz clic en "+ Nuevo Producto" para agregar el primero</small>
            </div>`;
          return;
        }

        grid.innerHTML = productos.map(p => `
          <div class="producto-card">
            <div class="producto-card-header">
              <h4>${p.nombre}</h4>
              <span class="producto-categoria">${p.categoria || 'General'}</span>
            </div>
            <p class="producto-descripcion">${p.descripcion || 'Sin descripci칩n'}</p>
            <div class="producto-info">
              <span class="producto-precio">$${p.precio.toFixed(2)}</span>
              <span class="producto-stock">Stock: <span>${p.stock}</span></span>
            </div>
            <div class="producto-acciones">
              <button class="btn-editar" onclick='abrirModal(${JSON.stringify(p)})'>Editar</button>
              <button class="btn-eliminar" onclick="confirmarEliminar('${p._id}')">Eliminar</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        mostrarToast('Error al cargar productos', 'error');
      }
    }

    async function guardarProducto(e) {
      e.preventDefault();
      const id = document.getElementById('productoId').value;
      const datos = {
        nombre: document.getElementById('nombre').value,
        descripcion: document.getElementById('descripcion').value,
        precio: parseFloat(document.getElementById('precio').value),
        categoria: document.getElementById('categoria').value || 'General',
        stock: parseInt(document.getElementById('stock').value) || 0
      };

      try {
        const url = id ? API + '/productos/' + id : API + '/productos';
        const method = id ? 'PUT' : 'POST';

        const res = await fetch(url, {
          method,
          headers: headers(),
          body: JSON.stringify(datos)
        });

        if (res.ok) {
          mostrarToast(id ? 'Producto actualizado' : 'Producto creado', 'exito');
          cerrarModal();
          cargarProductos();
        } else {
          const data = await res.json();
          mostrarToast(data.mensaje || 'Error al guardar', 'error');
        }
      } catch (err) {
        mostrarToast('Error de conexi칩n', 'error');
      }
    }

    cargarProductos();
  </script>
</body>
</html>
